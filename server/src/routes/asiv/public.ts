import { Router, Request, Response } from "express";

import { getTransactionInfo, handlePayment } from "../../services/asiv";
import { AsivTransactionInfo } from "../../utils";

const router: Router = Router();

// GET request - get the payment page
router.get("/payments/:tid", async (req: Request, res: Response) => {
  const tid: string = req.params.tid;
  const info: AsivTransactionInfo = getTransactionInfo(tid);

  return res.render("index", {
    layout: false,
    paymentTo: "Flora",
    userId: info.uid,
    productId: info.pid,
    productCost: info.pcost,
  });
});

// POST request - make a payment
router.post("/payments/:tid", async (req: Request, res: Response) => {
  const tid: string = req.params.tid;

  // this will throw ApiError if tid not found
  handlePayment(tid);

  res.json({
    message: "ACK",
  });
});

export default router;
