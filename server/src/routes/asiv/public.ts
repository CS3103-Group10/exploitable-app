import { Router, Request, Response } from "express";
import axios from "axios";

import { getTransactionInfo, processPayment } from "../../services/asiv";
import { AsivTransactionInfo, FLORA_API_KEY } from "../../utils";

const router: Router = Router();

// GET request - get the payment page
router.get("/payments/:tid", async (req: Request, res: Response) => {
  const tid: string = req.params.tid;
  const info: AsivTransactionInfo = getTransactionInfo(tid);

  return res.render("index", {
    layout: false,
    paymentTo: "Flora",
    userId: info.uid,
    productId: info.pid,
    productCost: info.pcost,
  });
});

// POST request - make a payment
router.post("/payments/:tid", async (req: Request, res: Response) => {
  const tid: string = req.params.tid;

  // try to process the payment
  const info: AsivTransactionInfo = processPayment(tid);

  // inform Flora that transaction was successful:
  await axios({
    method: "post",
    url: "http://localhost:8000/flora/api/products/purchase/successful",
    data: {
      API_KEY: FLORA_API_KEY,
      uid: info.uid,
      pid: info.pid,
    },
  });

  res.json({
    message: "Transaction success",
  });
});

export default router;
