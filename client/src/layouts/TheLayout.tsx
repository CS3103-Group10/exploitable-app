import React, { ReactNode, FC, useEffect, useState } from "react";
import { useRouter } from "next/router";
import Head from "next/head";
import Link from "next/link";
import { Layout, Menu, Row, Button, Dropdown } from "antd";
import { DownOutlined, UserOutlined } from "@ant-design/icons";

import { useAuth } from "src/hooks";

const { Header, Content } = Layout;

type Props = {
  children: ReactNode;
};

const urlToTitle: Readonly<Record<string, string>> = Object.freeze({
  "/": "Exploitable App",
  "/flora": "Flora",
  "/flora/login": "Flora | Login",
});

const TheLayout: FC<Props> = ({ children }): JSX.Element => {
  const router = useRouter();
  const { isAuthenticated, user, logout } = useAuth();
  const [selectedMenuKeys, setSelectedMenuKeys] = useState<string[]>([]);
  const [isFloraLayout, setIsFloraLayout] = useState<boolean>(false);

  useEffect(() => {
    // regex to get first URL path segment
    const selectedMenuKeys = router.pathname.match(/^\/[^\/]*/g);
    setSelectedMenuKeys(selectedMenuKeys ?? []);
    setIsFloraLayout(
      selectedMenuKeys ? selectedMenuKeys[0] === "/flora" : false,
    );
  }, [router.pathname]);

  // TODO: add indicator for logged in user
  return (
    <>
      <Head>
        <title>{urlToTitle[router.pathname] ?? urlToTitle["/"]}</title>
        <meta charSet="utf-8" />
        <meta name="viewport" content="initial-scale=1.0, width=device-width" />
      </Head>
      <Layout style={{ minHeight: "100vh" }}>
        {/* TOP NAV */}
        <Header>
          <Row align="middle" justify="space-between">
            <Menu
              mode="horizontal"
              theme="dark"
              style={{ fontSize: "17px" }}
              selectedKeys={selectedMenuKeys}
            >
              <Menu.Item key="/">
                <Link href="/">Instructions</Link>
              </Menu.Item>
              <Menu.Item key="/flora">
                <Link href="/flora">Flora</Link>
              </Menu.Item>
            </Menu>

            {isFloraLayout ? (
              isAuthenticated ? (
                <Dropdown
                  overlay={
                    <Menu>
                      <Menu.Item onClick={logout}>Logout</Menu.Item>
                    </Menu>
                  }
                >
                  <Button type="primary">
                    <UserOutlined /> {user?.uusername} <DownOutlined />
                  </Button>
                </Dropdown>
              ) : (
                <Button type="primary">
                  <Link href="/flora/login">Login</Link>
                </Button>
              )
            ) : null}
          </Row>
        </Header>

        {/* PAGE */}
        <Content style={{ padding: "1rem" }}>{children}</Content>

        {/* BOTTOM NAV */}
        {/* <Footer style={{ textAlign: "center" }}>This is the footer</Footer> */}
      </Layout>
    </>
  );
};

export default TheLayout;
